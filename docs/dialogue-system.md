# Многоуровневая Диалоговая Система EDEM

## Обзор

Многоуровневая диалоговая система EDEM представляет собой инновационный подход к психологическому самоанализу через AI-чат. Система состоит из трех последовательных этапов:

1. **Тень (Shadow)** - Отзеркаливание паттернов без советов
2. **Правда (Truth)** - Корневые потребности и контекст выбора
3. **Интеграция (Integration)** - Микро-практики и телесное закрепление

## Архитектура

### Машина состояний

```
stateDiagram-v2
    [*] --> Shadow
    Shadow --> Truth: user_acknowledged OR low_defensiveness
    Shadow --> Shadow: defensiveness_high OR avoidance
    Truth --> Integration: user_accepts_need AND readiness_score>=2
    Truth --> Shadow: denial OR blame_spike
    Integration --> Truth: practice_fail OR confusion
    Integration --> [*]: 3 successful check-ins
```

### Компоненты системы

1. **Детектор сигналов** - Анализирует ответы пользователя для определения готовности к переходу
2. **Машина состояний** - Управляет переходами между этапами
3. **RAG система** - Извлекает контекст из базы знаний
4. **Шаблоны промптов** - Версионированные шаблоны для каждого этапа
5. **Практики** - Микро-задания для этапа интеграции

## База знаний (RAG)

### Структура данных

Каждый документ в RAG системе содержит:

- **Заголовок** - Название темы
- **Этапы** - Список этапов, к которым относится документ
- **Симптомы** - Список симптомов
- **Архетипы** - Список психологических архетипов
- **Модальности** - Список модальностей (тело, дыхание, когнитивная и т.д.)
- **Язык** - Язык документа
- **Время чтения** - Ориентировочное время чтения
- **Текст** - Содержание документа

### Типы документов

1. **Глоссарий** - Определения паттернов и архетипов
2. **Протоколы** - Микро-практики (1-3 минуты)
3. **Карты** - Переходы от паттернов к потребностям
4. **Кейсы** - Примеры "было/стало"
5. **Этика** - Границы и кризисные скрипты

## API

### Основные эндпоинты

#### POST /api/dialogue

Обрабатывает сообщение пользователя и возвращает ответ системы.

**Параметры:**

```json
{
  "message": "Текст сообщения пользователя",
  "sessionId": "ID сессии",
  "symptoms": ["anxiety", "sleep"],
  "archetypes": ["victim"]
}
```

**Ответ:**

```json
{
  "response": "Ответ системы",
  "stage": "shadow|truth|integration",
  "timestamp": "2023-01-01T00:00:00Z"
}
```

#### GET /api/dialogue

Получает информацию о текущем состоянии диалога.

**Параметры:**

- `session_id` - ID сессии
- `action` - Тип действия (`state` или `practice`)

## Компоненты интерфейса

### MultiLevelChat

Основной компонент чата с поддержкой трех этапов диалога.

### StageIndicator

Индикатор текущего этапа диалога.

## Развертывание

### Миграции базы данных

```bash
npm run db:migrate:dialogue
```

### Импорт данных RAG

```bash
npm run import-rag-data
```

## Тестирование

Для тестирования системы доступна страница `/dialogue-test`.

## Метрики качества

1. **Процент переходов** - Доля пользователей, переходящих от Тени к Правде
2. **Возвраты** - Доля пользователей, возвращающихся на чек-ин
3. **Выполнение практик** - Процент выполненных практик
4. **Защитные механизмы** - Время пребывания в этапе Тени
