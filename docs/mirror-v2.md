# EDEM Mirror v2: Многоуровневая Диалоговая Система

## Обзор

EDEM Mirror v2 представляет собой улучшенную версию диалоговой системы с тремя уровнями взаимодействия:

1. **Тень (Shadow)** - Отзеркаливание паттернов без советов
2. **Правда (Truth)** - Корневые потребности и контекст выбора
3. **Интеграция (Integration)** - Микро-практики и телесное закрепление

## Архитектура

### Машина состояний

```
stateDiagram-v2
    [*] --> Shadow
    Shadow --> Truth: user_acknowledged OR low_defensiveness
    Shadow --> Shadow: defensiveness_high OR avoidance
    Truth --> Integration: user_accepts_need AND readiness_score>=2
    Truth --> Shadow: denial OR blame_spike
    Integration --> Truth: practice_fail OR confusion
    Integration --> [*]: 3 successful check-ins
```

### Компоненты системы

1. **Детектор сигналов** - Анализирует ответы пользователя
2. **Машина состояний** - Управляет переходами между этапами
3. **RAG система** - Извлекает контекст из базы знаний
4. **Шаблоны промптов** - Версионированные шаблоны для каждого этапа

## База знаний (RAG)

### Структура данных

Каждый документ в RAG системе содержит:

- **Заголовок** - Название темы
- **Этапы** - Список этапов, к которым относится документ
- **Симптомы** - Список симптомов
- **Архетипы** - Список психологических архетипов
- **Модальности** - Список модальностей (тело, дыхание, когнитивная и т.д.)
- **Язык** - Язык документа
- **Текст** - Содержание документа

### Типы документов

1. **Глоссарий** - Определения паттернов и архетипов
2. **Протоколы** - Микро-практики (1-3 минуты)
3. **Карты** - Переходы от паттернов к потребностям
4. **Кейсы** - Примеры "было/стало"
5. **Этика** - Границы и кризисные скрипты

## API

### Основные эндпоинты

#### POST /api/chat

Обрабатывает сообщение пользователя и возвращает ответ системы.

**Параметры:**

```json
{
  "text": "Текст сообщения пользователя",
  "sessionId": "ID сессии",
  "symptom": "anxiety",
  "lang": "ru"
}
```

**Ответ:**

```json
{
  "stage": "shadow|truth|integration",
  "answer": "Ответ системы",
  "context": ["Контекст 1", "Контекст 2"]
}
```

## Компоненты интерфейса

### MultiLevelChatV2

Основной компонент чата с поддержкой трех этапов диалога.

### CalibrationForm

Форма калибровки для сбора начальных данных пользователя.

## Развертывание

### Миграции базы данных

```bash
npm run db:migrate:rag
```

### Генерация стартового корпуса

```bash
npm run generate-corpus
```

### Генерация дополнительного корпуса

```bash
npm run generate-starter-corpus
```

### Генерация эмбеддингов

```bash
npm run generate-embeddings
```

### Генерация эмбеддингов для RAG чанков

```bash
npm run embed-rag-chunks
```

### Тестирование поиска по RAG

```bash
npm run test-rag-search
```

### Импорт данных RAG

```bash
npm run import-corpus
```

### Импорт данных RAG из JSON

```bash
npm run import-rag-json
```

### Генерация эмбеддингов для RAG

```bash
npm run generate-embeddings
```

### Генерация эмбеддингов для RAG чанков

```bash
npm run embed-rag-chunks
```

### Тестирование поиска по RAG

```bash
npm run test-rag-search
```

Дополнительную информацию см. в [документации по импорту RAG](./rag-import.md), [документации по генерации эмбеддингов](./embedding-generation.md) и [документации по RAG embeddings](./rag-embeddings.md)

## Тестирование

Для тестирования системы доступна страница `/mirror-v2`.

## Метрики качества

1. **Процент переходов** - Доля пользователей, переходящих от Тени к Правде
2. **Возвраты** - Доля пользователей, возвращающихся на чек-ин
3. **Выполнение практик** - Процент выполненных практик
4. **Защитные механизмы** - Время пребывания в этапе Тени

## Безопасность

Система включает в себя SOS-скрипт для обработки кризисных ситуаций:

- Самоповреждение
- Суицидальные мысли
- Галлюцинации
- Другие кризисные маркеры

При обнаружении таких маркеров система выдает фиксированный безопасный ответ и завершает сессию.
